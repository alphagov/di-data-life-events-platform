# 20. Vulnerability management

[Next >>](0021-github-robot-account.md)

Date: 2023-03-30

## Status

Draft for discussion

## Context

We use Security Hub in AWS as a central view into all of our vulnerabilities. These all get logged into the Findings
section of Security Hub either via Config (which reports AWS services best practices and vulnerabilities) or via
Inspector (which reports all the scanning of our ECR images). This means that we have one central place we would like to
either solve or suppress our vulnerabilities from.

Security Hub sadly however does not have a nice way to programmatically suppress these findings when they come through,
so for example known vulnerabilities in images that aren't exposed in our use case will still show up for every new
image we push, even if we suppress it the first time it show. As a result we want a way to programmatically suppress
these findings.

## Approach

AWS suggests [here](https://aws.amazon.com/blogs/security/how-to-create-auto-suppression-rules-in-aws-security-hub/)
that for this kind of desired outcome, you should use a system of lambdas and events, so we have decided to implement a
solution similar to this (but not exactly the same as this) ourselves.

This is the process that our system will use to suppress new findings:

1. A finding gets pushed to Security Hub
2. This triggers an EventBridge event that triggers a lambda
3. The lambda checks against a DynamoDB table to see if we have a suppression for a finding with that Title for that
   Resource
4. If the lambda finds a matching suppression, it will suppress this event in SecurityHub, if not it lets the finding
   stay like normal

This is the process that our system will use to suppress existing findings with new suppressions:

1. Someone adds to the list of suppressions in `ci/update_securityhub_suppressions/suppressions.yml`
2. This is pushed to main (after PR), and a workflow runs that updates the DynamoDB with these suppressions
3. The DynamoDB sends an event stream to the lambda after it is updated, this event stream contains the updated
   suppressions
4. The lambda pulls all non-suppressed findings that match the Title of the updated suppressions
5. The lambda checks the resources match for the suppression, and if so suppresses the matching existing findings

## Consequences

In order for all this to work, we have to have a lambda to perform these actions, an EventBridge event and a DynamoDB
stream event that triggers the lambda, and a DynamoDB table to store the list of suppressions.

[Next >>](0021-github-robot-account.md)

